<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Builder | Ford Scott Financial Planning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fs-teal': { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a' },
                        'fs-gold': { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                        'fs-slate': { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { 'heading': ['DM Sans', 'sans-serif'], 'body': ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', system-ui, sans-serif; }
        h1, h2, h3, h4, h5, h6, .font-heading { font-family: 'DM Sans', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #0d9488; border-radius: 4px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .transition-smooth { transition: all 0.2s ease; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        @media print { .no-print { display: none !important; } body { background: white; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-fs-slate-50 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        // ============================================
        // DATA & CONSTANTS
        // ============================================
        const INVESTMENTS = {
            "LONSEC RETIREMENT MANAGED PORTFOLIO - CONSERVATIVE": { mer: 0.0095, growth: 0.395, defensive: 0.605, assetClass: "DIVERSIFIED" },
            "LONSEC RETIREMENT MANAGED PORTFOLIO - BALANCED": { mer: 0.0099, growth: 0.605, defensive: 0.395, assetClass: "DIVERSIFIED" },
            "LONSEC RETIREMENT MANAGED PORTFOLIO - GROWTH": { mer: 0.0106, growth: 0.805, defensive: 0.195, assetClass: "DIVERSIFIED" },
            "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": { mer: 0.0051, growth: 0.38, defensive: 0.62, assetClass: "DIVERSIFIED" },
            "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": { mer: 0.005, growth: 0.575, defensive: 0.425, assetClass: "DIVERSIFIED" },
            "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": { mer: 0.0051, growth: 0.77, defensive: 0.23, assetClass: "DIVERSIFIED" },
            "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": { mer: 0.0051, growth: 0.98, defensive: 0.02, assetClass: "DIVERSIFIED" },
            "Lonsec Sustainable Managed Portfolios - Balanced": { mer: 0.0074, growth: 0.58, defensive: 0.42, assetClass: "DIVERSIFIED" },
            "Lonsec Sustainable Managed Portfolios - Growth": { mer: 0.0082, growth: 0.765, defensive: 0.235, assetClass: "DIVERSIFIED" },
            "Lonsec Sustainable Managed Portfolios - High Growth": { mer: 0.0088, growth: 0.955, defensive: 0.045, assetClass: "DIVERSIFIED" },
            "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": { mer: 0.00605, growth: 1.0, defensive: 0.0, assetClass: "AUSTRALIAN EQUITIES" },
            "Quest Australian Equities Concentrated SMA": { mer: 0.006, growth: 1.0, defensive: 0.0, assetClass: "AUSTRALIAN EQUITIES" },
            "DNR Capital Australian Equities Socially Responsible Portfolio": { mer: 0.00605, growth: 1.0, defensive: 0.0, assetClass: "AUSTRALIAN EQUITIES" },
            "Australian Ethical High Conviction": { mer: 0.0045, growth: 1.0, defensive: 0.0, assetClass: "AUSTRALIAN EQUITIES" },
            "Aoris International Fund (BAOR)": { mer: 0.008, growth: 1.0, defensive: 0.0, assetClass: "GLOBAL EQUITIES" },
            "Plato Global Alpha Fund (PGA1)": { mer: 0.0075, growth: 1.0, defensive: 0.0, assetClass: "GLOBAL EQUITIES" },
            "Pzena Global Focused Value Fund - Wholesale Class": { mer: 0.0075, growth: 1.0, defensive: 0.0, assetClass: "GLOBAL EQUITIES" },
            "Fidelity Future Leaders Fund": { mer: 0.0075, growth: 1.0, defensive: 0.0, assetClass: "GLOBAL EQUITIES" },
            "Nanuk New World Fund (ETF NNUK or Managed Fund)": { mer: 0.0111, growth: 1.0, defensive: 0.0, assetClass: "GLOBAL EQUITIES" },
            "Macquarie Dynamic Bond Fund": { mer: 0.0068, growth: 0.0, defensive: 1.0, assetClass: "FIXED INCOME" },
            "CASH": { mer: 0.0, growth: 0.0, defensive: 1.0, assetClass: "CASH" },
            "Term Deposit 1": { mer: 0.0, growth: 0.0, defensive: 1.0, assetClass: "TERM DEPOSIT" },
            "Term Deposit 2": { mer: 0.0, growth: 0.0, defensive: 1.0, assetClass: "TERM DEPOSIT" }
        };

        const MODELS = {
            "accumulation-under350k-standard": { "conservative": { "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 95.0, "CASH": 5.0 }, "balanced": { "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 95.0, "CASH": 5.0 }, "growth": { "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 95.0, "CASH": 5.0 }, "highGrowth": { "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 95.0, "CASH": 5.0 } },
            "accumulation-under350k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 73.0, "CASH": 7.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 42.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 55.0, "CASH": 3.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 55.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 43.0, "CASH": 2.0 }, "highGrowth": { "Lonsec Sustainable Managed Portfolios - High Growth": 48.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 50.0, "CASH": 2.0 } },
            "pension-under350k-standard": { "conservative": { "LONSEC RETIREMENT MANAGED PORTFOLIO - CONSERVATIVE": 40.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 45.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "balanced": { "LONSEC RETIREMENT MANAGED PORTFOLIO - BALANCED": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 55.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "growth": { "LONSEC RETIREMENT MANAGED PORTFOLIO - GROWTH": 40.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 50.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "pension-under350k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 55.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 55.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 40.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 50.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "accumulation-350k-500k-standard": { "conservative": { "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 65.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 6.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 5.0 }, "balanced": { "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 7.0, "Quest Australian Equities Concentrated SMA": 5.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "growth": { "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 9.0, "Quest Australian Equities Concentrated SMA": 7.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 3.0, "Macquarie Dynamic Bond Fund": 4.0, "CASH": 4.0 }, "highGrowth": { "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 11.0, "Quest Australian Equities Concentrated SMA": 8.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 6.0, "CASH": 2.0 } },
            "accumulation-350k-500k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 50.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 4.0, "Aoris International Fund (BAOR)": 4.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 7.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 8.0, "Australian Ethical High Conviction": 5.0, "Aoris International Fund (BAOR)": 8.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 3.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 6.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 9.0, "Australian Ethical High Conviction": 8.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 4.0, "Macquarie Dynamic Bond Fund": 4.0, "CASH": 2.0 }, "highGrowth": { "Lonsec Sustainable Managed Portfolios - High Growth": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 11.0, "Australian Ethical High Conviction": 8.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 6.0, "CASH": 2.0 } },
            "pension-350k-500k-standard": { "conservative": { "LONSEC RETIREMENT MANAGED PORTFOLIO - CONSERVATIVE": 40.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 3.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 8.0 }, "balanced": { "LONSEC RETIREMENT MANAGED PORTFOLIO - BALANCED": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 33.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 8.0, "Quest Australian Equities Concentrated SMA": 7.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 4.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 }, "growth": { "LONSEC RETIREMENT MANAGED PORTFOLIO - GROWTH": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 10.0, "Quest Australian Equities Concentrated SMA": 10.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 7.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "pension-350k-500k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 45.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 3.0, "Aoris International Fund (BAOR)": 7.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 10.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 33.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 8.0, "Australian Ethical High Conviction": 7.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 4.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 10.0, "Australian Ethical High Conviction": 10.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 7.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "accumulation-500k-750k-standard": { "conservative": { "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 65.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 6.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 5.0 }, "balanced": { "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 7.0, "Quest Australian Equities Concentrated SMA": 5.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 5.0 }, "growth": { "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 9.0, "Quest Australian Equities Concentrated SMA": 7.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 3.0, "Macquarie Dynamic Bond Fund": 4.0, "CASH": 4.0 }, "highGrowth": { "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 11.0, "Quest Australian Equities Concentrated SMA": 8.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 6.0, "CASH": 2.0 } },
            "accumulation-500k-750k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 50.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 4.0, "Aoris International Fund (BAOR)": 4.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 7.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 8.0, "Australian Ethical High Conviction": 5.0, "Aoris International Fund (BAOR)": 8.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 3.0, "Macquarie Dynamic Bond Fund": 10.0, "CASH": 6.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 9.0, "Australian Ethical High Conviction": 8.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 4.0, "Macquarie Dynamic Bond Fund": 4.0, "CASH": 2.0 }, "highGrowth": { "Lonsec Sustainable Managed Portfolios - High Growth": 30.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 11.0, "Australian Ethical High Conviction": 8.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 6.0, "CASH": 2.0 } },
            "pension-500k-750k-standard": { "conservative": { "LONSEC RETIREMENT MANAGED PORTFOLIO - CONSERVATIVE": 40.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 3.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 8.0 }, "balanced": { "LONSEC RETIREMENT MANAGED PORTFOLIO - BALANCED": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 33.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 8.0, "Quest Australian Equities Concentrated SMA": 7.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 4.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 }, "growth": { "LONSEC RETIREMENT MANAGED PORTFOLIO - GROWTH": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 10.0, "Quest Australian Equities Concentrated SMA": 10.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 7.0, "Pzena Global Focused Value Fund - Wholesale Class": 7.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "pension-500k-750k-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 45.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 3.0, "Aoris International Fund (BAOR)": 7.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 10.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 33.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 8.0, "Australian Ethical High Conviction": 7.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 4.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 10.0, "Australian Ethical High Conviction": 10.0, "Aoris International Fund (BAOR)": 13.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 7.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "accumulation-750k-plus-standard": { "conservative": { "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 60.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 5.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Pzena Global Focused Value Fund - Wholesale Class": 3.0, "Fidelity Future Leaders Fund": 2.0, "Macquarie Dynamic Bond Fund": 16.0, "CASH": 5.0 }, "balanced": { "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 56.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 7.0, "Quest Australian Equities Concentrated SMA": 4.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Pzena Global Focused Value Fund - Wholesale Class": 3.0, "Fidelity Future Leaders Fund": 4.0, "Macquarie Dynamic Bond Fund": 12.0, "CASH": 5.0 }, "growth": { "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 55.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 10.0, "Quest Australian Equities Concentrated SMA": 6.0, "Aoris International Fund (BAOR)": 5.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Pzena Global Focused Value Fund - Wholesale Class": 6.0, "Fidelity Future Leaders Fund": 5.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 3.0 }, "highGrowth": { "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 55.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 12.0, "Quest Australian Equities Concentrated SMA": 7.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 6.0, "Pzena Global Focused Value Fund - Wholesale Class": 7.0, "Fidelity Future Leaders Fund": 5.0, "CASH": 2.0 } },
            "accumulation-750k-plus-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 15.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 5.0, "Aoris International Fund (BAOR)": 9.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 3.0, "Fidelity Future Leaders Fund": 2.0, "Macquarie Dynamic Bond Fund": 25.0, "CASH": 11.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 7.0, "Australian Ethical High Conviction": 4.0, "Aoris International Fund (BAOR)": 9.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 3.0, "Fidelity Future Leaders Fund": 4.0, "Macquarie Dynamic Bond Fund": 12.0, "CASH": 6.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 10.0, "Australian Ethical High Conviction": 6.0, "Aoris International Fund (BAOR)": 10.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 6.0, "Fidelity Future Leaders Fund": 5.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 3.0 }, "highGrowth": { "Lonsec Sustainable Managed Portfolios - High Growth": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - HIGH GROWTH": 30.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 12.0, "Australian Ethical High Conviction": 7.0, "Aoris International Fund (BAOR)": 12.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 7.0, "Fidelity Future Leaders Fund": 5.0, "CASH": 2.0 } },
            "pension-750k-plus-standard": { "conservative": { "LONSEC RETIREMENT MANAGED PORTFOLIO - CONSERVATIVE": 25.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 35.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 6.0, "Aoris International Fund (BAOR)": 4.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Macquarie Dynamic Bond Fund": 17.0, "CASH": 8.0 }, "balanced": { "LONSEC RETIREMENT MANAGED PORTFOLIO - BALANCED": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 9.0, "Quest Australian Equities Concentrated SMA": 5.0, "Aoris International Fund (BAOR)": 5.0, "Plato Global Alpha Fund (PGA1)": 5.0, "Pzena Global Focused Value Fund - Wholesale Class": 5.0, "Fidelity Future Leaders Fund": 5.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 6.0 }, "growth": { "LONSEC RETIREMENT MANAGED PORTFOLIO - GROWTH": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR CAPITAL AUSTRALIAN EQUITIES HIGH CONVICTION PORTFOLIO": 12.0, "Quest Australian Equities Concentrated SMA": 8.0, "Aoris International Fund (BAOR)": 6.0, "Plato Global Alpha Fund (PGA1)": 6.0, "Pzena Global Focused Value Fund - Wholesale Class": 8.0, "Fidelity Future Leaders Fund": 5.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } },
            "pension-750k-plus-esg": { "conservative": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - CONSERVATIVE": 40.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 3.0, "Aoris International Fund (BAOR)": 9.0, "Macquarie Dynamic Bond Fund": 18.0, "CASH": 10.0 }, "balanced": { "Lonsec Sustainable Managed Portfolios - Balanced": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - BALANCED": 25.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 9.0, "Australian Ethical High Conviction": 5.0, "Aoris International Fund (BAOR)": 10.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 5.0, "Fidelity Future Leaders Fund": 4.0, "Macquarie Dynamic Bond Fund": 15.0, "CASH": 7.0 }, "growth": { "Lonsec Sustainable Managed Portfolios - Growth": 20.0, "LONSEC LISTED MANAGED PORTFOLIO - GROWTH": 25.0, "DNR Capital Australian Equities Socially Responsible Portfolio": 12.0, "Australian Ethical High Conviction": 8.0, "Aoris International Fund (BAOR)": 12.0, "Nanuk New World Fund (ETF NNUK or Managed Fund)": 8.0, "Fidelity Future Leaders Fund": 5.0, "Macquarie Dynamic Bond Fund": 5.0, "CASH": 5.0 } }
        };

        const TRANSACTION_TYPES = ["New Investment", "Rebalance", "Review Only"];
        const PRIORITIES = ["Standard", "Urgent", "ASAP"];
        const ASSET_CLASSES = ["DIVERSIFIED", "AUSTRALIAN EQUITIES", "GLOBAL EQUITIES", "FIXED INCOME", "CASH", "TERM DEPOSIT", "PROPERTY", "ALTERNATIVES"];
        const STORAGE_KEY = 'fordscott_portfolios_v14';
        const MER_PASSWORD = 'Timmy';
        const RISK_PROFILE_RANGES = { conservative: { min: 30, max: 50, label: 'Conservative' }, balanced: { min: 50, max: 70, label: 'Balanced' }, growth: { min: 70, max: 85, label: 'Growth' }, highGrowth: { min: 85, max: 100, label: 'High Growth' } };
        const ASSET_CLASS_COLORS = { 'DIVERSIFIED': '#0d9488', 'AUSTRALIAN EQUITIES': '#0891b2', 'GLOBAL EQUITIES': '#6366f1', 'FIXED INCOME': '#8b5cf6', 'CASH': '#94a3b8', 'TERM DEPOSIT': '#64748b', 'PROPERTY': '#f59e0b', 'ALTERNATIVES': '#ec4899' };

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://wptivonhdjlnosbqzjfm.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_eOFRSxODbYnE4MpycE03rQ_XzokyKWb';

        const supabase = {
            async fetchInvestments() {
                const resp = await fetch(`${SUPABASE_URL}/rest/v1/investments?select=*&active=eq.true&order=sort_order.asc`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                if (!resp.ok) throw new Error('Failed to fetch investments');
                return resp.json();
            },
            async fetchSharedPortfolios() {
                const resp = await fetch(`${SUPABASE_URL}/rest/v1/shared_portfolios?select=*&order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                if (!resp.ok) throw new Error('Failed to fetch shared portfolios');
                return resp.json();
            },
            async saveSharedPortfolio(name, description, data) {
                const resp = await fetch(`${SUPABASE_URL}/rest/v1/shared_portfolios`, {
                    method: 'POST',
                    headers: { 
                        'apikey': SUPABASE_ANON_KEY, 
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({ name, description, data_json: data, created_by: 'ford-scott-team' })
                });
                if (!resp.ok) throw new Error('Failed to save portfolio');
                return resp.json();
            }
        };


        // ============================================
        // ICONS
        // ============================================
        const Icons = {
            TrendingUp: () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>),
            Umbrella: () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" /></svg>),
            Save: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>),
            Copy: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>),
            Check: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>),
            Plus: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>),
            X: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>),
            Trash: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>),
            Refresh: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>),
            AlertTriangle: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>),
            Leaf: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>),
            ShieldCheck: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>),
            ChevronDown: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>),
            Lock: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>),
            Unlock: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>),
            Camera: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /></svg>),
            GitCompare: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>),
            ArrowUp: () => (<svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7" /></svg>),
            ArrowDown: () => (<svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>),
            Eye: () => (<svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>),
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const getBalanceRange = (balance) => { if (balance < 350000) return "under350k"; if (balance < 500000) return "350k-500k"; if (balance < 750000) return "500k-750k"; return "750k-plus"; };
        const getModelKey = (accountType, balanceRange, isESG) => `${accountType.toLowerCase()}-${balanceRange}${isESG ? "-esg" : "-standard"}`;
        const formatCurrency = (amount) => new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        const formatPercent = (decimal, digits = 2) => (decimal * 100).toFixed(digits) + '%';
        const formatDate = (date) => new Date(date).toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getSavedPortfolios = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch (e) { return {}; } };
        const savePortfolioToStorage = (name, data) => { try { const p = getSavedPortfolios(); p[name] = { ...data, savedAt: new Date().toISOString() }; localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); return true; } catch (e) { return false; } };
        const deletePortfolioFromStorage = (name) => { try { const p = getSavedPortfolios(); delete p[name]; localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); return true; } catch (e) { return false; } };

        const calculateAccountTotals = (allocations, balance, customInvestments = {}, merOverrides = {}) => {
            const allInvestments = { ...INVESTMENTS, ...customInvestments };
            let totalAllocation = 0, weightedMER = 0, totalGrowth = 0, totalDefensive = 0;
            const assetClassBreakdown = {};
            Object.entries(allocations).forEach(([name, pct]) => {
                const inv = allInvestments[name];
                if (inv && pct > 0) {
                    const effectiveMER = merOverrides[name] !== undefined ? merOverrides[name] : inv.mer;
                    totalAllocation += pct; weightedMER += (pct / 100) * effectiveMER;
                    totalGrowth += (pct / 100) * inv.growth; totalDefensive += (pct / 100) * inv.defensive;
                    assetClassBreakdown[inv.assetClass] = (assetClassBreakdown[inv.assetClass] || 0) + pct;
                }
            });
            return { totalAllocation, weightedMER, totalGrowth: totalGrowth * 100, totalDefensive: totalDefensive * 100, totalFees: balance * weightedMER, assetClassBreakdown };
        };

        const getModelAllocations = (accountType, balance, isESG, riskProfile) => {
            const model = MODELS[getModelKey(accountType, getBalanceRange(balance), isESG)];
            return model?.[riskProfile] ? {...model[riskProfile]} : {};
        };

        // ============================================
        // DELTA INDICATOR (for snapshot comparison)
        // ============================================
        function DeltaIndicator({ current, baseline, format = 'percent' }) {
            if (baseline === null || baseline === undefined) return null;
            const delta = current - baseline;
            if (Math.abs(delta) < 0.01) return null;
            const isPositive = delta > 0;
            return (
                <span className={`inline-flex items-center gap-0.5 text-xs font-medium ml-1 ${isPositive ? 'text-emerald-600' : 'text-red-500'}`}>
                    {isPositive ? <Icons.ArrowUp /> : <Icons.ArrowDown />}
                    {format === 'currency' ? (isPositive ? '+' : '') + formatCurrency(delta) : (isPositive ? '+' : '') + delta.toFixed(1) + '%'}
                </span>
            );
        }

        // ============================================
        // COMPARISON SUMMARY BANNER
        // ============================================
        function ComparisonSummary({ current, baseline, onClear, onViewDetails, savedAt }) {
            if (!baseline) return null;
            const items = [
                { label: 'Growth', current: current.weightedGrowth, baseline: baseline.weightedGrowth, format: 'percent', invertColor: false },
                { label: 'Defensive', current: current.weightedDefensive, baseline: baseline.weightedDefensive, format: 'percent', invertColor: false },
                { label: 'MER', current: current.weightedMER * 100, baseline: baseline.weightedMER * 100, format: 'mer', invertColor: true },
                { label: 'Annual Fees', current: current.totalFees, baseline: baseline.totalFees, format: 'currency', invertColor: true },
            ];
            const balanceDelta = current.totalBalance - baseline.totalBalance;
            return (
                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-4 mb-4 text-white animate-slide-in">
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                            <Icons.GitCompare />
                            <span className="font-heading font-semibold">Comparison Mode</span>
                            <span className="text-xs bg-white/20 px-2 py-0.5 rounded-full">Snapshot: {savedAt ? new Date(savedAt).toLocaleString('en-AU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'vs Snapshot'}</span>
                            {Math.abs(balanceDelta) > 0 && <span className={`text-xs px-2 py-0.5 rounded-full ${balanceDelta > 0 ? 'bg-emerald-500/30' : 'bg-red-500/30'}`}>Balance {balanceDelta > 0 ? '+' : ''}{formatCurrency(balanceDelta)}</span>}
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={onViewDetails} className="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition-smooth flex items-center gap-1"><Icons.Eye /> View Details</button>
                            <button onClick={onClear} className="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition-smooth">Clear</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-4 gap-3">
                        {items.map(item => {
                            const delta = item.current - item.baseline;
                            const isPositive = delta > 0;
                            const colorClass = item.invertColor ? (isPositive ? 'text-red-300' : 'text-emerald-300') : (isPositive ? 'text-emerald-300' : 'text-red-300');
                            return (
                                <div key={item.label} className="bg-white/10 rounded-lg p-3">
                                    <div className="text-xs text-white/70 mb-1">{item.label}</div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-lg font-bold tabular-nums">{item.format === 'currency' ? formatCurrency(item.current) : item.format === 'mer' ? `${item.current.toFixed(2)}%` : `${item.current.toFixed(1)}%`}</span>
                                        {Math.abs(delta) > 0.01 && <span className={`text-sm font-medium ${colorClass}`}>{isPositive ? '+' : ''}{item.format === 'currency' ? formatCurrency(delta) : item.format === 'mer' ? `${delta.toFixed(2)}%` : `${delta.toFixed(1)}%`}</span>}
                                    </div>
                                    <div className="text-xs text-white/50 mt-1">Was: {item.format === 'currency' ? formatCurrency(item.baseline) : item.format === 'mer' ? `${item.baseline.toFixed(2)}%` : `${item.baseline.toFixed(1)}%`}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ============================================
        // INVESTMENT COMPARISON MODAL
        // ============================================
        function InvestmentComparisonModal({ isOpen, onClose, baseline, accounts, customInvestments, merOverrides }) {
            const [selectedAccountId, setSelectedAccountId] = React.useState(null);
            const [showOnlyChanges, setShowOnlyChanges] = React.useState(false);

            React.useEffect(() => {
                if (isOpen && accounts.length > 0 && !selectedAccountId) {
                    setSelectedAccountId(accounts[0].id);
                }
            }, [isOpen, accounts]);

            if (!isOpen || !baseline) return null;

            const allInvestments = { ...INVESTMENTS, ...customInvestments };
            const baselineInvestments = { ...INVESTMENTS, ...baseline.customInvestments };

            // Find matching baseline account
            const currentAccount = accounts.find(a => a.id === selectedAccountId);
            const baselineAccount = baseline.accounts.find(a => a.id === selectedAccountId);

            if (!currentAccount) return null;

            // Build comparison data
            const comparisonData = [];
            const allInvNames = new Set([
                ...Object.keys(currentAccount.allocations || {}),
                ...(baselineAccount ? Object.keys(baselineAccount.allocations || {}) : [])
            ]);

            allInvNames.forEach(name => {
                const currentPct = currentAccount.allocations?.[name] || 0;
                const baselinePct = baselineAccount?.allocations?.[name] || 0;
                const inv = allInvestments[name] || baselineInvestments[name];

                if (!inv) return;

                const currentAmt = currentAccount.balance * (currentPct / 100);
                const baselineAmt = baselineAccount ? baselineAccount.balance * (baselinePct / 100) : 0;
                const pctDelta = currentPct - baselinePct;
                const amtDelta = currentAmt - baselineAmt;

                const isNew = baselinePct === 0 && currentPct > 0;
                const isRemoved = baselinePct > 0 && currentPct === 0;
                const isChanged = Math.abs(pctDelta) > 0.1;

                comparisonData.push({
                    name,
                    assetClass: inv.assetClass,
                    currentPct,
                    baselinePct,
                    currentAmt,
                    baselineAmt,
                    pctDelta,
                    amtDelta,
                    isNew,
                    isRemoved,
                    isChanged: isChanged && !isNew && !isRemoved
                });
            });

            // Sort: changes first, then by absolute delta
            comparisonData.sort((a, b) => {
                if (a.isNew !== b.isNew) return a.isNew ? -1 : 1;
                if (a.isRemoved !== b.isRemoved) return a.isRemoved ? -1 : 1;
                return Math.abs(b.pctDelta) - Math.abs(a.pctDelta);
            });

            const filteredData = showOnlyChanges
                ? comparisonData.filter(d => d.isNew || d.isRemoved || d.isChanged)
                : comparisonData.filter(d => d.currentPct > 0 || d.baselinePct > 0);

            // Summary stats
            const totalChanges = comparisonData.filter(d => d.isNew || d.isRemoved || d.isChanged).length;
            const newCount = comparisonData.filter(d => d.isNew).length;
            const removedCount = comparisonData.filter(d => d.isRemoved).length;
            const rebalanceAmount = comparisonData.reduce((sum, d) => sum + Math.abs(d.pctDelta), 0) / 2;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col animate-fade-in">
                        <div className="px-5 py-4 border-b border-fs-slate-200 flex justify-between items-center flex-shrink-0">
                            <div>
                                <h3 className="font-heading font-semibold text-fs-slate-800 text-lg">Investment Comparison</h3>
                                <p className="text-xs text-fs-slate-500">Snapshot vs Current â€¢ {baseline.savedAt ? new Date(baseline.savedAt).toLocaleString('en-AU') : ''}</p>
                            </div>
                            <button onClick={onClose} className="text-fs-slate-400 hover:text-fs-slate-600 p-1"><Icons.X /></button>
                        </div>

                        <div className="px-5 py-3 border-b border-fs-slate-200 flex flex-wrap items-center gap-3 bg-fs-slate-50 flex-shrink-0">
                            <div className="flex gap-1">
                                {accounts.map(acc => (
                                    <button key={acc.id} onClick={() => setSelectedAccountId(acc.id)} className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-smooth ${selectedAccountId === acc.id ? 'bg-fs-teal-600 text-white' : 'bg-white border border-fs-slate-300 text-fs-slate-600 hover:bg-fs-slate-100'}`}>
                                        {acc.accountType === 'accumulation' ? 'Super' : 'Pension'} {formatCurrency(acc.balance)}
                                    </button>
                                ))}
                            </div>
                            <div className="flex-1"></div>
                            <label className="flex items-center gap-2 text-sm text-fs-slate-600 cursor-pointer">
                                <input type="checkbox" checked={showOnlyChanges} onChange={(e) => setShowOnlyChanges(e.target.checked)} className="rounded border-fs-slate-300" />
                                Show only changes
                            </label>
                        </div>

                        <div className="px-5 py-3 border-b border-fs-slate-200 grid grid-cols-4 gap-4 flex-shrink-0">
                            <div className="bg-indigo-50 rounded-lg p-3 text-center">
                                <div className="text-2xl font-bold text-indigo-700">{totalChanges}</div>
                                <div className="text-xs text-indigo-600">Changes</div>
                            </div>
                            <div className="bg-emerald-50 rounded-lg p-3 text-center">
                                <div className="text-2xl font-bold text-emerald-700">{newCount}</div>
                                <div className="text-xs text-emerald-600">Added</div>
                            </div>
                            <div className="bg-red-50 rounded-lg p-3 text-center">
                                <div className="text-2xl font-bold text-red-700">{removedCount}</div>
                                <div className="text-xs text-red-600">Removed</div>
                            </div>
                            <div className="bg-amber-50 rounded-lg p-3 text-center">
                                <div className="text-2xl font-bold text-amber-700">{rebalanceAmount.toFixed(1)}%</div>
                                <div className="text-xs text-amber-600">Turnover</div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto">
                            <table className="w-full">
                                <thead className="sticky top-0 bg-fs-teal-50 z-10">
                                    <tr>
                                        <th className="text-left px-4 py-2 text-xs font-semibold text-fs-teal-800 uppercase">Investment</th>
                                        <th className="text-right px-3 py-2 text-xs font-semibold text-fs-teal-800 uppercase w-24">Snapshot</th>
                                        <th className="text-right px-3 py-2 text-xs font-semibold text-fs-teal-800 uppercase w-24">Current</th>
                                        <th className="text-right px-3 py-2 text-xs font-semibold text-fs-teal-800 uppercase w-28">Change</th>
                                        <th className="text-center px-2 py-2 text-xs font-semibold text-fs-teal-800 uppercase w-20">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.length === 0 ? (
                                        <tr><td colSpan="5" className="px-4 py-8 text-center text-fs-slate-500">No investments to display</td></tr>
                                    ) : filteredData.map((row, idx) => (
                                        <tr key={row.name} className={`border-b border-fs-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-fs-slate-50/50'} ${row.isRemoved ? 'opacity-60' : ''}`}>
                                            <td className="px-4 py-2">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: ASSET_CLASS_COLORS[row.assetClass] || '#94a3b8' }}></div>
                                                    <div>
                                                        <span className={`text-sm ${row.isRemoved ? 'line-through text-fs-slate-400' : 'text-fs-slate-800'}`}>{row.name}</span>
                                                        <span className="block text-xs text-fs-slate-400">{row.assetClass}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-3 py-2 text-right">
                                                <div className="text-sm tabular-nums text-fs-slate-600">{row.baselinePct.toFixed(1)}%</div>
                                                <div className="text-xs tabular-nums text-fs-slate-400">{formatCurrency(row.baselineAmt)}</div>
                                            </td>
                                            <td className="px-3 py-2 text-right">
                                                <div className="text-sm tabular-nums text-fs-slate-800 font-medium">{row.currentPct.toFixed(1)}%</div>
                                                <div className="text-xs tabular-nums text-fs-slate-500">{formatCurrency(row.currentAmt)}</div>
                                            </td>
                                            <td className="px-3 py-2 text-right">
                                                {Math.abs(row.pctDelta) > 0.01 && (
                                                    <div className={`text-sm tabular-nums font-medium ${row.pctDelta > 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                        {row.pctDelta > 0 ? '+' : ''}{row.pctDelta.toFixed(1)}%
                                                    </div>
                                                )}
                                                {Math.abs(row.amtDelta) > 1 && (
                                                    <div className={`text-xs tabular-nums ${row.amtDelta > 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                                                        {row.amtDelta > 0 ? '+' : ''}{formatCurrency(row.amtDelta)}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="px-2 py-2 text-center">
                                                {row.isNew && <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded">NEW</span>}
                                                {row.isRemoved && <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-medium rounded">REMOVED</span>}
                                                {row.isChanged && <span className="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded">CHANGED</span>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="px-5 py-4 border-t border-fs-slate-200 flex justify-end flex-shrink-0">
                            <button onClick={onClose} className="px-4 py-2 bg-fs-teal-600 text-white rounded-lg text-sm font-medium hover:bg-fs-teal-700">Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // CUSTOM INVESTMENT MODAL
        // ============================================
        function CustomInvestmentModal({ isOpen, onClose, onAdd }) {
            const [name, setName] = React.useState('');
            const [mer, setMer] = React.useState(0.5);
            const [assetClass, setAssetClass] = React.useState('DIVERSIFIED');
            const [growth, setGrowth] = React.useState(50);
            const handleAdd = () => {
                if (!name.trim()) return alert('Please enter investment name');
                onAdd({ name: name.trim(), mer: mer / 100, growth: growth / 100, defensive: (100 - growth) / 100, assetClass, isCustom: true });
                setName(''); setMer(0.5); setAssetClass('DIVERSIFIED'); setGrowth(50);
                onClose();
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 animate-fade-in">
                        <div className="px-5 py-4 border-b border-fs-slate-200 flex justify-between items-center">
                            <h3 className="font-heading font-semibold text-fs-slate-800">Add Custom Investment</h3>
                            <button onClick={onClose} className="text-fs-slate-400 hover:text-fs-slate-600"><Icons.X /></button>
                        </div>
                        <div className="p-5 space-y-4">
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Investment Name</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Legacy Holding XYZ" className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" /></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">MER (%)</label><input type="number" value={mer} onChange={(e) => setMer(parseFloat(e.target.value) || 0)} step="0.01" min="0" max="5" className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" /></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Asset Class</label><select value={assetClass} onChange={(e) => setAssetClass(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white">{ASSET_CLASSES.map(ac => <option key={ac} value={ac}>{ac}</option>)}</select></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Growth / Defensive Split</label><div className="flex items-center gap-3"><span className="text-xs text-fs-teal-600 w-20">Growth {growth}%</span><input type="range" min="0" max="100" value={growth} onChange={(e) => setGrowth(parseInt(e.target.value))} className="flex-1" style={{background: 'linear-gradient(to right, #0d9488, #94a3b8)'}} /><span className="text-xs text-fs-slate-500 w-24">Defensive {100 - growth}%</span></div></div>
                        </div>
                        <div className="px-5 py-4 border-t border-fs-slate-200 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-fs-slate-600 hover:bg-fs-slate-100 rounded-lg text-sm">Cancel</button>
                            <button onClick={handleAdd} className="px-4 py-2 bg-fs-teal-600 text-white rounded-lg text-sm font-medium hover:bg-fs-teal-700">Add Investment</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // EXPORT DROPDOWN
        // ============================================
        function ExportDropdown({ onExport, copied, hasBaseline }) {
            const [isOpen, setIsOpen] = React.useState(false);
            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className={`px-4 py-2 rounded-lg text-sm font-medium transition-smooth flex items-center gap-2 ${copied ? 'bg-emerald-600 text-white' : 'bg-fs-teal-600 text-white hover:bg-fs-teal-700'}`}>
                        {copied ? <><Icons.Check /> Copied</> : <><Icons.Copy /> Export <Icons.ChevronDown /></>}
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 top-full mt-2 w-72 bg-white rounded-lg shadow-lg border border-fs-slate-200 z-50 animate-fade-in">
                            <button onClick={() => { onExport('paraplanner'); setIsOpen(false); }} className="w-full px-4 py-3 text-left hover:bg-fs-slate-50 rounded-t-lg border-b border-fs-slate-100">
                                <div className="font-medium text-fs-slate-800 text-sm">Paraplanner Handoff</div>
                                <div className="text-xs text-fs-slate-500">Full details for WealthSolver replication</div>
                            </button>
                            <button
                                onClick={() => { if (hasBaseline) { onExport('roa'); setIsOpen(false); } }}
                                disabled={!hasBaseline}
                                className={`w-full px-4 py-3 text-left rounded-b-lg ${hasBaseline ? 'hover:bg-fs-slate-50' : 'opacity-50 cursor-not-allowed'}`}
                            >
                                <div className="font-medium text-fs-slate-800 text-sm flex items-center gap-2">
                                    ROA - Replacement of Product
                                    {!hasBaseline && <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Need Snapshot</span>}
                                </div>
                                <div className="text-xs text-fs-slate-500">Existing vs Proposed comparison table</div>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // VISUAL COMPONENTS
        // ============================================
        function DonutChart({ data, size = 100, strokeWidth = 14, title = "By Class" }) {
            const radius = (size - strokeWidth) / 2, circumference = 2 * Math.PI * radius, center = size / 2;
            let currentOffset = 0;
            const segments = Object.entries(data).filter(([_, v]) => v > 0).map(([label, value]) => {
                const segment = { label, value, color: ASSET_CLASS_COLORS[label] || '#94a3b8', offset: currentOffset, length: (value / 100) * circumference };
                currentOffset += segment.length;
                return segment;
            });
            return (
                <div className="flex items-center gap-3">
                    <div className="relative" style={{ width: size, height: size }}>
                        <svg width={size} height={size} className="transform -rotate-90">
                            <circle cx={center} cy={center} r={radius} fill="none" stroke="#e2e8f0" strokeWidth={strokeWidth} />
                            {segments.map((s) => <circle key={s.label} cx={center} cy={center} r={radius} fill="none" stroke={s.color} strokeWidth={strokeWidth} strokeDasharray={`${s.length} ${circumference}`} strokeDashoffset={-s.offset} />)}
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center"><span className="text-xs font-medium text-fs-slate-500">{title}</span></div>
                    </div>
                    <div className="flex flex-col gap-0.5 text-xs">
                        {segments.slice(0, 4).map(s => (
                            <div key={s.label} className="flex items-center gap-1.5">
                                <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: s.color }}></div>
                                <span className="text-fs-slate-600 truncate max-w-20">{s.label}</span>
                                <span className="font-medium text-fs-slate-800 tabular-nums">{s.value.toFixed(0)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function GrowthDefensiveBar({ growth, defensive, baselineGrowth = null }) {
            return (
                <div className="w-full">
                    <div className="flex justify-between text-xs mb-1">
                        <span className="font-medium text-fs-teal-700">Growth {growth.toFixed(1)}%<DeltaIndicator current={growth} baseline={baselineGrowth} /></span>
                        <span className="font-medium text-fs-slate-500">Defensive {defensive.toFixed(1)}%</span>
                    </div>
                    <div className="h-4 rounded-full overflow-hidden flex bg-fs-slate-200 relative">
                        <div className="bg-gradient-to-r from-fs-teal-500 to-fs-teal-600 transition-all" style={{ width: `${growth}%` }} />
                        <div className="bg-gradient-to-r from-fs-slate-300 to-fs-slate-400 transition-all" style={{ width: `${defensive}%` }} />
                        {baselineGrowth !== null && <div className="absolute top-0 bottom-0 w-0.5 bg-indigo-600 z-10" style={{ left: `${baselineGrowth}%` }} title={`Snapshot: ${baselineGrowth.toFixed(1)}%`} />}
                    </div>
                </div>
            );
        }

        function VolatilityMeter({ growthPercent, riskProfile }) {
            // Calculate expected volatility based on growth allocation
            // Conservative estimates: 3% base + up to 15% additional based on growth
            const volatility = 3 + (growthPercent / 100) * 15;
            const expectedReturn = 4 + (growthPercent / 100) * 4; // 4% base + up to 4% more
            const badYear = Math.round(expectedReturn - 1.5 * volatility);
            const goodYear = Math.round(expectedReturn + 1.5 * volatility);

            const expectedRange = RISK_PROFILE_RANGES[riskProfile];
            const isWithinRange = growthPercent >= expectedRange.min && growthPercent <= expectedRange.max;

            // Volatility category
            const getVolatilityLabel = (vol) => {
                if (vol < 6) return { label: 'Low', color: 'text-emerald-600', bg: 'bg-emerald-100' };
                if (vol < 10) return { label: 'Moderate', color: 'text-amber-600', bg: 'bg-amber-100' };
                if (vol < 14) return { label: 'High', color: 'text-orange-600', bg: 'bg-orange-100' };
                return { label: 'Very High', color: 'text-red-600', bg: 'bg-red-100' };
            };
            const volCategory = getVolatilityLabel(volatility);

            return (
                <div className="flex flex-col items-center w-full">
                    <div className="text-center mb-2">
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${volCategory.bg} ${volCategory.color}`}>{volCategory.label} Volatility</span>
                    </div>
                    <div className="w-full px-2">
                        <div className="flex justify-between text-xs text-fs-slate-500 mb-1">
                            <span>Bad Year</span>
                            <span>Expected</span>
                            <span>Good Year</span>
                        </div>
                        <div className="relative h-6 bg-gradient-to-r from-red-200 via-fs-slate-200 to-emerald-200 rounded-full overflow-hidden">
                            <div className="absolute inset-0 flex items-center justify-between px-2">
                                <span className="text-xs font-bold text-red-700 tabular-nums">{badYear}%</span>
                                <span className="text-xs font-medium text-fs-slate-600 tabular-nums">~{expectedReturn.toFixed(0)}%</span>
                                <span className="text-xs font-bold text-emerald-700 tabular-nums">+{goodYear}%</span>
                            </div>
                        </div>
                    </div>
                    <div className="text-xs text-fs-slate-400 mt-1.5">Ïƒ {volatility.toFixed(1)}% annual</div>
                    {!isWithinRange && <div className={`text-xs font-medium mt-1 ${growthPercent < expectedRange.min ? 'text-blue-600' : 'text-orange-600'}`}>{growthPercent < expectedRange.min ? 'Below' : 'Above'} {expectedRange.label} range</div>}
                </div>
            );
        }

        function ValidationWarnings({ allocations, riskProfile, totals }) {
            const warnings = [];
            if (Math.abs(totals.totalAllocation - 100) > 0.1) warnings.push({ type: 'error', msg: `Allocation is ${totals.totalAllocation.toFixed(1)}%` });
            const range = RISK_PROFILE_RANGES[riskProfile];
            if (totals.totalGrowth < range.min) warnings.push({ type: 'warning', msg: `Growth below ${range.label} range` });
            else if (totals.totalGrowth > range.max) warnings.push({ type: 'warning', msg: `Growth exceeds ${range.label} range` });
            Object.entries(allocations).forEach(([n, p]) => { if (p > 60) warnings.push({ type: 'warning', msg: `High concentration (${p.toFixed(0)}%)` }); });
            if (warnings.length === 0) return <div className="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700"><Icons.ShieldCheck /><span className="text-xs font-medium">All checks passed</span></div>;
            return <div className="space-y-1">{warnings.map((w, i) => <div key={i} className={`flex items-start gap-2 px-3 py-2 rounded-lg border text-xs ${w.type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-amber-50 border-amber-200 text-amber-700'}`}><Icons.AlertTriangle /><span>{w.msg}</span></div>)}</div>;
        }

        // ============================================
        // ACCOUNT PANEL
        // ============================================
        function AccountPanel({ account, onUpdate, onRemove, canRemove, customInvestments, merOverrides, onMerChange, merUnlocked, onUnlockMer, baselineTotals }) {
            const profileLabels = { conservative: 'Conservative', balanced: 'Balanced', growth: 'Growth', highGrowth: 'High Growth' };
            const isSuper = account.accountType === 'accumulation';
            const availableProfiles = React.useMemo(() => (account.accountType === 'pension' && getBalanceRange(account.balance) === '750k-plus') ? ['conservative', 'balanced', 'growth'] : ['conservative', 'balanced', 'growth', 'highGrowth'], [account.accountType, account.balance]);
            const allInvestments = { ...INVESTMENTS, ...customInvestments };
            const totals = React.useMemo(() => calculateAccountTotals(account.allocations, account.balance, customInvestments, merOverrides), [account.allocations, account.balance, customInvestments, merOverrides]);
            const [investmentToAdd, setInvestmentToAdd] = React.useState('');
            const [showCharts, setShowCharts] = React.useState(true);
            const [showCustomModal, setShowCustomModal] = React.useState(false);

            const loadModel = () => { const n = getModelAllocations(account.accountType, account.balance, account.isESG, account.riskProfile); onUpdate({ ...account, allocations: n, recommendedAllocations: n }); };
            React.useEffect(() => { if (Object.keys(account.allocations).length === 0) loadModel(); }, []);
            React.useEffect(() => { if (!availableProfiles.includes(account.riskProfile)) onUpdate({ ...account, riskProfile: availableProfiles[availableProfiles.length - 1] }); }, [availableProfiles]);

            const handleSettingChange = (f, v) => { const u = { ...account, [f]: v }; const n = getModelAllocations(f === 'accountType' ? v : account.accountType, f === 'balance' ? v : account.balance, f === 'isESG' ? v : account.isESG, f === 'riskProfile' ? v : account.riskProfile); u.allocations = n; u.recommendedAllocations = n; onUpdate(u); };
            const handleAutoBalance = () => {
                const diff = 100 - totals.totalAllocation; if (Math.abs(diff) < 0.1) return;
                const cashKey = Object.keys(account.allocations).find(k => k === 'CASH');
                if (cashKey) onUpdate({ ...account, allocations: { ...account.allocations, [cashKey]: Math.round(Math.max(0, account.allocations[cashKey] + diff) * 100) / 100 } });
                else if (totals.totalAllocation > 0) { const f = 100 / totals.totalAllocation; const n = {}; Object.entries(account.allocations).forEach(([k, p]) => { n[k] = Math.round(p * f * 100) / 100; }); onUpdate({ ...account, allocations: n }); }
            };

            const availableInvestments = Object.keys(allInvestments).filter(n => !account.allocations.hasOwnProperty(n));
            const allocationValid = Math.abs(totals.totalAllocation - 100) < 0.1;

            return (
                <div className="bg-white rounded-xl shadow-sm border border-fs-slate-200 mb-6 overflow-hidden animate-fade-in">
                    <div className={`px-5 py-4 border-b ${isSuper ? 'bg-gradient-to-r from-fs-teal-600 to-fs-teal-700' : 'bg-gradient-to-r from-fs-teal-800 to-fs-teal-900'}`}>
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center text-white">{isSuper ? <Icons.TrendingUp /> : <Icons.Umbrella />}</div>
                                <div><h3 className="font-heading font-semibold text-white text-lg">{isSuper ? 'Accumulation (Super)' : 'Pension'}</h3><p className="text-white/80 text-sm">{formatCurrency(account.balance)} â€¢ {profileLabels[account.riskProfile]}{account.isESG ? ' â€¢ ESG' : ''}</p></div>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${allocationValid ? 'bg-white/20 text-white' : 'bg-red-500 text-white'}`}>{totals.totalAllocation.toFixed(1)}%</span>
                                {canRemove && <button onClick={onRemove} className="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg"><Icons.X /></button>}
                            </div>
                        </div>
                    </div>

                    <div className="px-5 py-4 bg-fs-slate-50 border-b border-fs-slate-200">
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase tracking-wide">Account Type</label><select value={account.accountType} onChange={(e) => handleSettingChange('accountType', e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white"><option value="accumulation">Accumulation</option><option value="pension">Pension</option></select></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase tracking-wide">Account Number</label><input type="text" value={account.accountNumber || ''} onChange={(e) => onUpdate({ ...account, accountNumber: e.target.value })} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white" placeholder="e.g. 24269284" /></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase tracking-wide">Balance</label><input type="number" value={account.balance} onChange={(e) => handleSettingChange('balance', parseFloat(e.target.value) || 0)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white tabular-nums" step="10000" /></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase tracking-wide">Style</label><button onClick={() => handleSettingChange('isESG', !account.isESG)} className={`w-full px-3 py-2 rounded-lg border text-sm font-medium flex items-center justify-center gap-2 ${account.isESG ? 'bg-emerald-50 border-emerald-300 text-emerald-700' : 'bg-white border-fs-slate-300 text-fs-slate-700'}`}>{account.isESG && <Icons.Leaf />}{account.isESG ? 'ESG' : 'Standard'}</button></div>
                            <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase tracking-wide">Risk Profile</label><select value={account.riskProfile} onChange={(e) => handleSettingChange('riskProfile', e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white">{availableProfiles.map(p => <option key={p} value={p}>{profileLabels[p]}</option>)}</select></div>
                        </div>
                    </div>

                    <div className="px-5 py-4 bg-white border-b border-fs-slate-200">
                        <div className="flex items-center justify-between mb-3">
                            <h4 className="font-heading font-semibold text-fs-slate-800">Analytics</h4>
                            <button onClick={() => setShowCharts(!showCharts)} className="text-xs text-fs-slate-500 hover:text-fs-teal-600">{showCharts ? 'Hide' : 'Show'}</button>
                        </div>
                        {showCharts && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div className="bg-fs-slate-50 rounded-lg p-3"><DonutChart data={totals.assetClassBreakdown} /></div>
                                <div className="bg-fs-slate-50 rounded-lg p-3 flex flex-col justify-center"><GrowthDefensiveBar growth={totals.totalGrowth} defensive={totals.totalDefensive} baselineGrowth={baselineTotals?.totalGrowth} /></div>
                                <div className="bg-fs-slate-50 rounded-lg p-3 flex items-center justify-center"><VolatilityMeter growthPercent={totals.totalGrowth} riskProfile={account.riskProfile} /></div>
                            </div>
                        )}
                        <ValidationWarnings allocations={account.allocations} riskProfile={account.riskProfile} totals={totals} />
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead>
                                <tr className="bg-fs-teal-50 border-b border-fs-teal-100">
                                    <th className="text-left px-5 py-3 text-xs font-semibold text-fs-teal-800 uppercase">Investment</th>
                                    <th className="text-right px-3 py-3 text-xs font-semibold text-fs-teal-800 uppercase w-20">Model</th>
                                    <th className="text-right px-3 py-3 text-xs font-semibold text-fs-teal-800 uppercase w-24">Alloc</th>
                                    <th className="text-right px-3 py-3 text-xs font-semibold text-fs-teal-800 uppercase w-28">Amount</th>
                                    <th className="text-right px-3 py-3 text-xs font-semibold text-fs-teal-800 uppercase w-24">
                                        <div className="flex items-center justify-end gap-1">
                                            MER
                                            <button onClick={onUnlockMer} className={`p-1 rounded transition-smooth ${merUnlocked ? 'text-amber-600 hover:bg-amber-100' : 'text-fs-teal-600 hover:bg-fs-teal-100'}`} title={merUnlocked ? 'MER Unlocked - Click to lock' : 'MER Locked - Click to unlock'}>
                                                {merUnlocked ? <Icons.Unlock /> : <Icons.Lock />}
                                            </button>
                                        </div>
                                    </th>
                                    <th className="text-right px-3 py-3 text-xs font-semibold text-fs-teal-800 uppercase w-24">Fee p.a.</th>
                                    <th className="w-12"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.entries(account.allocations).map(([name, pct], idx) => {
                                    const inv = allInvestments[name]; if (!inv) return null;
                                    const effectiveMER = merOverrides[name] !== undefined ? merOverrides[name] : inv.mer;
                                    const amount = account.balance * (pct / 100), fee = amount * effectiveMER;
                                    const recPct = account.recommendedAllocations?.[name], isDiff = recPct !== undefined && Math.abs(pct - recPct) > 0.1;
                                    const isCustom = customInvestments[name];
                                    const isMerOverridden = merOverrides[name] !== undefined && merOverrides[name] !== inv.mer;
                                    return (
                                        <tr key={name} className={`border-b border-fs-slate-100 hover:bg-fs-slate-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-fs-slate-50/50'}`}>
                                            <td className="px-5 py-3"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: ASSET_CLASS_COLORS[inv.assetClass] || '#94a3b8' }}></div><div><span className="text-sm text-fs-slate-800">{name}{isCustom && <span className="ml-1 text-xs bg-purple-100 text-purple-600 px-1 rounded">Custom</span>}</span><span className="block text-xs text-fs-slate-400">{inv.assetClass}</span></div></div></td>
                                            <td className={`px-3 py-3 text-right text-sm tabular-nums ${isDiff ? 'text-fs-gold-600 font-medium' : 'text-fs-slate-400'}`}>{recPct?.toFixed(1) || 'â€”'}%</td>
                                            <td className="px-3 py-3"><input type="number" value={pct} onChange={(e) => onUpdate({ ...account, allocations: { ...account.allocations, [name]: parseFloat(e.target.value) || 0 } })} className={`w-full text-right border rounded-md px-2 py-1.5 text-sm tabular-nums ${isDiff ? 'border-fs-gold-400 bg-fs-gold-50' : 'border-fs-slate-200'}`} step="1" /></td>
                                            <td className="px-3 py-3"><input type="number" value={Math.round(amount)} onChange={(e) => { const a = parseFloat(e.target.value) || 0; onUpdate({ ...account, allocations: { ...account.allocations, [name]: Math.round((a / account.balance) * 10000) / 100 } }); }} className="w-full text-right border border-fs-slate-200 rounded-md px-2 py-1.5 text-sm tabular-nums" step="1000" /></td>
                                            <td className="px-3 py-3 text-right">
                                                {merUnlocked ? (
                                                    <input type="number" value={(effectiveMER * 100).toFixed(2)} onChange={(e) => onMerChange(name, parseFloat(e.target.value) / 100)} className={`w-20 text-right border rounded-md px-2 py-1.5 text-sm tabular-nums ${isMerOverridden ? 'border-amber-400 bg-amber-50' : 'border-fs-slate-200'}`} step="0.01" />
                                                ) : (
                                                    <span className={`text-sm tabular-nums ${isMerOverridden ? 'text-amber-600 font-medium' : 'text-fs-slate-500'}`}>{formatPercent(effectiveMER)}</span>
                                                )}
                                            </td>
                                            <td className="px-3 py-3 text-right text-sm text-fs-slate-700 tabular-nums font-medium">{formatCurrency(fee)}</td>
                                            <td className="px-3 py-3"><button onClick={() => { const n = { ...account.allocations }; delete n[name]; onUpdate({ ...account, allocations: n }); }} className="p-1.5 text-fs-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><Icons.Trash /></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot><tr className="bg-fs-slate-100 border-t-2 border-fs-slate-200"><td className="px-5 py-3 text-sm font-semibold text-fs-slate-700" colSpan="2">TOTAL</td><td className={`px-3 py-3 text-right text-sm font-bold tabular-nums ${allocationValid ? 'text-emerald-600' : 'text-red-600'}`}>{totals.totalAllocation.toFixed(1)}%</td><td className="px-3 py-3 text-right text-sm font-semibold text-fs-slate-700 tabular-nums">{formatCurrency(account.balance)}</td><td className="px-3 py-3 text-right text-sm font-medium text-fs-slate-600 tabular-nums">{formatPercent(totals.weightedMER)}</td><td className="px-3 py-3 text-right text-sm font-bold text-fs-teal-700 tabular-nums">{formatCurrency(totals.totalFees)}</td><td></td></tr></tfoot>
                        </table>
                    </div>

                    <div className="px-5 py-4 bg-fs-slate-50 border-t border-fs-slate-200 flex flex-wrap gap-3 items-center">
                        <select value={investmentToAdd} onChange={(e) => setInvestmentToAdd(e.target.value)} className="flex-1 min-w-48 border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white"><option value="">Add investment...</option>{availableInvestments.map(n => <option key={n} value={n}>{n}{customInvestments[n] ? ' (Custom)' : ''}</option>)}</select>
                        <button onClick={() => { if (investmentToAdd) { onUpdate({ ...account, allocations: { ...account.allocations, [investmentToAdd]: 0 } }); setInvestmentToAdd(''); } }} disabled={!investmentToAdd} className="px-4 py-2 bg-fs-teal-600 text-white rounded-lg text-sm font-medium hover:bg-fs-teal-700 disabled:bg-fs-slate-300 disabled:cursor-not-allowed flex items-center gap-2"><Icons.Plus /> Add</button>
                        <button onClick={() => setShowCustomModal(true)} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 flex items-center gap-2"><Icons.Plus /> Custom</button>
                        <button onClick={handleAutoBalance} disabled={allocationValid} className="px-4 py-2 bg-fs-gold-500 text-white rounded-lg text-sm font-medium hover:bg-fs-gold-600 disabled:bg-fs-slate-300 disabled:cursor-not-allowed">Auto-Balance</button>
                        <button onClick={loadModel} className="px-4 py-2 bg-fs-slate-200 text-fs-slate-700 rounded-lg text-sm font-medium hover:bg-fs-slate-300 flex items-center gap-2"><Icons.Refresh /> Reset</button>
                    </div>

                    <CustomInvestmentModal isOpen={showCustomModal} onClose={() => setShowCustomModal(false)} onAdd={(inv) => { onUpdate({ ...account, allocations: { ...account.allocations, [inv.name]: 0 } }, inv); }} />
                </div>
            );
        }

        // ============================================
        // MAIN APP
        // ============================================
        
        // ============================================
        // SHARE TO TEAM MODAL
        // ============================================
        function ShareToTeamModal({ isOpen, onClose, onSave, saving }) {
            const [name, setName] = React.useState('');
            const [description, setDescription] = React.useState('');

            const handleSubmit = () => {
                if (name.trim() && description.trim()) {
                    onSave(name, description);
                    setName('');
                    setDescription('');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 animate-fade-in">
                        <h3 className="font-heading font-semibold text-fs-slate-800 text-lg mb-4">Share Portfolio to Team</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Portfolio Name</label>
                                <input 
                                    type="text" 
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="e.g. John Smith - Conservative Growth"
                                    className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Description</label>
                                <textarea 
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    placeholder="Notes about this portfolio..."
                                    className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm h-20 resize-none"
                                />
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button 
                                onClick={onClose}
                                disabled={saving}
                                className="flex-1 px-4 py-2 border border-fs-slate-300 text-fs-slate-600 rounded-lg text-sm font-medium hover:bg-fs-slate-50"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleSubmit}
                                disabled={!name.trim() || !description.trim() || saving}
                                className="flex-1 px-4 py-2 bg-fs-teal-600 text-white rounded-lg text-sm font-medium hover:bg-fs-teal-700 disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Share'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // SHARED PORTFOLIOS LIST MODAL
        // ============================================
        function SharedPortfoliosModal({ isOpen, onClose, onLoad, portfolios, loading }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col animate-fade-in">
                        <div className="px-5 py-4 border-b border-fs-slate-200 flex justify-between items-center flex-shrink-0">
                            <h3 className="font-heading font-semibold text-fs-slate-800 text-lg">Team Shared Portfolios</h3>
                            <button onClick={onClose} className="text-fs-slate-400 hover:text-fs-slate-600 p-1"><Icons.X /></button>
                        </div>
                        <div className="flex-1 overflow-auto">
                            {loading ? (
                                <div className="p-8 text-center text-fs-slate-500">Loading portfolios...</div>
                            ) : portfolios.length === 0 ? (
                                <div className="p-8 text-center text-fs-slate-500">No shared portfolios available</div>
                            ) : (
                                <div className="divide-y divide-fs-slate-200">
                                    {portfolios.map(p => (
                                        <div key={p.id} className="p-4 hover:bg-fs-slate-50 transition-smooth">
                                            <div className="flex items-start justify-between gap-4">
                                                <div className="flex-1">
                                                    <h4 className="font-medium text-fs-slate-800 mb-1">{p.name}</h4>
                                                    <p className="text-xs text-fs-slate-500 mb-2">{p.description}</p>
                                                    <p className="text-xs text-fs-slate-400">Shared by: {p.created_by} â€¢ {new Date(p.created_at).toLocaleDateString()}</p>
                                                </div>
                                                <button 
                                                    onClick={() => onLoad(p)}
                                                    className="px-3 py-1.5 bg-fs-teal-600 text-white rounded-lg text-sm font-medium hover:bg-fs-teal-700 whitespace-nowrap"
                                                >
                                                    Load
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

function App() {
            const profileLabels = { conservative: 'Conservative', balanced: 'Balanced', growth: 'Growth', highGrowth: 'High Growth' };
            const [clientName, setClientName] = React.useState('');
            const [sharedPortfolios, setSharedPortfolios] = React.useState([]);
            const [loadingSharedPortfolios, setLoadingSharedPortfolios] = React.useState(false);
            const [showShareModal, setShowShareModal] = React.useState(false);
            const [showSharedPortfoliosModal, setShowSharedPortfoliosModal] = React.useState(false);
            const [savingShare, setSavingShare] = React.useState(false);
            const [shareMessage, setShareMessage] = React.useState('');

            const [platform, setPlatform] = React.useState('HUB24');
            const [platformOther, setPlatformOther] = React.useState('');
            const [adviserName, setAdviserName] = React.useState('');
            const [transactionType, setTransactionType] = React.useState('New Investment');
            const [priority, setPriority] = React.useState('Standard');
            const [dateCreated, setDateCreated] = React.useState(new Date().toISOString().split('T')[0]);
            const [notes, setNotes] = React.useState('');
            const [accounts, setAccounts] = React.useState([{ id: generateId(), accountType: 'accumulation', balance: 400000, isESG: false, riskProfile: 'balanced', allocations: {}, recommendedAllocations: {}, accountNumber: '' }]);
            const [customInvestments, setCustomInvestments] = React.useState({});
            const [merOverrides, setMerOverrides] = React.useState({});
            const [savedPortfoliosList, setSavedPortfoliosList] = React.useState([]);
            const [selectedSavedPortfolio, setSelectedSavedPortfolio] = React.useState('');
            const [copied, setCopied] = React.useState(false);
            const [merUnlocked, setMerUnlocked] = React.useState(false);
            const [baseline, setBaseline] = React.useState(null);
            const [showComparisonModal, setShowComparisonModal] = React.useState(false);

            const effectivePlatform = platform === 'Other' ? platformOther : platform;

            React.useEffect(() => { setSavedPortfoliosList(Object.keys(getSavedPortfolios())); }, []);

            // Load shared portfolios from Supabase on mount
            React.useEffect(() => {
                setLoadingSharedPortfolios(true);
                supabase.fetchSharedPortfolios()
                    .then(setSharedPortfolios)
                    .catch(error => console.error('Error loading shared portfolios:', error))
                    .finally(() => setLoadingSharedPortfolios(false));
            }, []);


            const combinedTotals = React.useMemo(() => {
                let totalBalance = 0, totalFees = 0;
                accounts.forEach(a => { const t = calculateAccountTotals(a.allocations, a.balance, customInvestments, merOverrides); totalBalance += a.balance; totalFees += t.totalFees; });
                let weightedGrowth = 0, weightedDefensive = 0, weightedMER = 0;
                if (totalBalance > 0) accounts.forEach(a => { const t = calculateAccountTotals(a.allocations, a.balance, customInvestments, merOverrides); weightedGrowth += (a.balance / totalBalance) * t.totalGrowth; weightedDefensive += (a.balance / totalBalance) * t.totalDefensive; weightedMER += (a.balance / totalBalance) * t.weightedMER; });
                return { totalBalance, totalFees, weightedGrowth, weightedDefensive, weightedMER };
            }, [accounts, customInvestments, merOverrides]);

            const baselineAccountTotals = React.useMemo(() => {
                if (!baseline) return {};
                const result = {};
                baseline.accounts.forEach(acc => { result[acc.id] = calculateAccountTotals(acc.allocations, acc.balance, baseline.customInvestments || {}, baseline.merOverrides || {}); });
                return result;
            }, [baseline]);

            const updateAccount = (u, newCustomInv) => {
                setAccounts(p => p.map(a => a.id === u.id ? u : a));
                if (newCustomInv) setCustomInvestments(prev => ({ ...prev, [newCustomInv.name]: newCustomInv }));
            };
            const removeAccount = (id) => accounts.length > 1 && setAccounts(p => p.filter(a => a.id !== id));
            const addAccount = (type) => setAccounts(p => [...p, { id: generateId(), accountType: type, balance: type === 'accumulation' ? 400000 : 300000, isESG: false, riskProfile: 'balanced', allocations: {}, recommendedAllocations: {}, accountNumber: '' }]);

            const handleSaveSnapshot = () => setBaseline({ accounts: JSON.parse(JSON.stringify(accounts)), totals: { ...combinedTotals }, customInvestments: { ...customInvestments }, merOverrides: { ...merOverrides }, savedAt: new Date().toISOString() });
            const handleClearSnapshot = () => setBaseline(null);

            const handleMerUnlock = () => {
                if (merUnlocked) { setMerUnlocked(false); }
                else {
                    const pw = prompt('Enter password to unlock MER editing:');
                    if (pw === MER_PASSWORD) setMerUnlocked(true);
                    else if (pw !== null) alert('Incorrect password');
                }
            };

            const handleMerChange = (investmentName, newMer) => {
                setMerOverrides(prev => ({ ...prev, [investmentName]: newMer }));
            };

            const handleSavePortfolio = () => {
                const name = prompt('Portfolio name:', clientName || 'New Portfolio');
                if (name && savePortfolioToStorage(name, { clientName, platform, platformOther, adviserName, transactionType, priority, dateCreated, notes, accounts, customInvestments, merOverrides })) {
                    setSavedPortfoliosList(Object.keys(getSavedPortfolios()));
                    alert(`Saved "${name}"`);
                }
            };

            const handleLoadPortfolio = (name) => {
                if (!name) return;
                const p = getSavedPortfolios()[name];
                if (p) {
                    setClientName(p.clientName || ''); setPlatform(p.platform || 'HUB24'); setPlatformOther(p.platformOther || '');
                    setAdviserName(p.adviserName || ''); setTransactionType(p.transactionType || 'New Investment');
                    setPriority(p.priority || 'Standard'); setDateCreated(p.dateCreated || new Date().toISOString().split('T')[0]);
                    setNotes(p.notes || ''); setAccounts(p.accounts || []);
                    setCustomInvestments(p.customInvestments || {}); setMerOverrides(p.merOverrides || {});
                    setSelectedSavedPortfolio(name); setBaseline(null);
                }
            };

            const handleDeletePortfolio = () => { if (!selectedSavedPortfolio || !confirm(`Delete "${selectedSavedPortfolio}"?`)) return; deletePortfolioFromStorage(selectedSavedPortfolio); setSavedPortfoliosList(Object.keys(getSavedPortfolios())); setSelectedSavedPortfolio(''); };

            const handleExport = (format) => {
                const allInvestments = { ...INVESTMENTS, ...customInvestments };
                const baselineInvestments = baseline ? { ...INVESTMENTS, ...baseline.customInvestments } : {};
                let html = '';

                if (format === 'roa' && baseline) {
                    // ROA - Replacement of Product format (EXACT match to Word document)
                    // Font: Open Sans Light 10pt, Header bg: #A5ACAF, Investment text: #808080
                    // No visible borders, vertical-align: center
                    const fontStack = `'Open Sans', 'Segoe UI', Calibri, Arial, sans-serif`;
                    const tableStyle = `border-collapse: collapse; width: 100%; font-family: ${fontStack}; font-size: 10pt; font-weight: 300; background: #fff;`;
                    const headerCellStyle = `padding: 5px 7px; text-align: left; background-color: #A5ACAF; color: #000; font-weight: 300; vertical-align: middle; border: none;`;
                    const headerCellRightStyle = `padding: 5px 7px; text-align: center; background-color: #A5ACAF; color: #000; font-weight: 300; vertical-align: middle; border: none;`;
                    const accountHeaderStyle = `padding: 5px 7px; background-color: #fff; font-weight: bold; text-align: left; vertical-align: middle; color: #000; border: none;`;
                    const cellStyle = `padding: 3px 7px; color: #808080; vertical-align: middle; font-weight: 300; border: none;`;
                    const cellRightStyle = `padding: 3px 7px; text-align: center; color: #808080; vertical-align: middle; font-weight: 300; border: none; line-height: 1.3;`;
                    const totalCellStyle = `padding: 5px 7px; font-weight: bold; color: #000; vertical-align: middle; border: none;`;
                    const totalCellRightStyle = `padding: 5px 7px; text-align: center; font-weight: bold; color: #000; vertical-align: middle; border: none; line-height: 1.3;`;
                    const diffRowStyle = `padding: 5px 7px; color: #000; text-align: left; vertical-align: middle; font-weight: 300; border: none;`;

                    html = `<div style="font-family: ${fontStack}; font-weight: 300; max-width: 600px; color: #000; background: #fff; font-size: 10pt;">`;

                    // For each account
                    accounts.forEach(currentAccount => {
                        const baselineAccount = baseline.accounts.find(a => a.id === currentAccount.id);
                        if (!baselineAccount) return;

                        const accountTypeLabel = currentAccount.accountType === 'accumulation' ? 'Super (Choice)' : 'Pension - Choice';
                        const accountHeader = `${clientName || 'Client'} - ${effectivePlatform} ${accountTypeLabel}${currentAccount.accountNumber ? ' - ' + currentAccount.accountNumber : ''}`;

                        html += `<table style="${tableStyle}" cellspacing="0" cellpadding="0">`;
                        html += `<tr><td style="${headerCellStyle}" width="42%">Investment Fees and Costs</td><td style="${headerCellRightStyle}" width="29%">Existing</td><td style="${headerCellRightStyle}" width="29%">Proposed</td></tr>`;
                        html += `<tr><td colspan="3" style="${accountHeaderStyle}">${accountHeader}</td></tr>`;

                        // Get all investments from both baseline and current
                        const allInvNames = new Set([
                            ...Object.keys(currentAccount.allocations || {}).filter(n => currentAccount.allocations[n] > 0),
                            ...Object.keys(baselineAccount.allocations || {}).filter(n => baselineAccount.allocations[n] > 0)
                        ]);

                        let existingTotalFee = 0, proposedTotalFee = 0;
                        let existingWeightedMER = 0, proposedWeightedMER = 0;

                        allInvNames.forEach(name => {
                            const existingPct = baselineAccount.allocations?.[name] || 0;
                            const proposedPct = currentAccount.allocations?.[name] || 0;
                            const inv = allInvestments[name] || baselineInvestments[name];
                            if (!inv || (existingPct === 0 && proposedPct === 0)) return;

                            const existingMER = baseline.merOverrides?.[name] !== undefined ? baseline.merOverrides[name] : inv.mer;
                            const proposedMER = merOverrides[name] !== undefined ? merOverrides[name] : inv.mer;

                            const existingAmt = baselineAccount.balance * (existingPct / 100);
                            const proposedAmt = currentAccount.balance * (proposedPct / 100);
                            const existingFee = existingAmt * existingMER;
                            const proposedFee = proposedAmt * proposedMER;

                            existingTotalFee += existingFee;
                            proposedTotalFee += proposedFee;
                            if (existingPct > 0) existingWeightedMER += (existingPct / 100) * existingMER;
                            if (proposedPct > 0) proposedWeightedMER += (proposedPct / 100) * proposedMER;

                            html += `<tr>`;
                            html += `<td style="${cellStyle}">${name}</td>`;
                            html += `<td style="${cellRightStyle}">${existingPct > 0 ? `$${Math.round(existingFee).toLocaleString()}<br>${(existingMER * 100).toFixed(2)}%` : '$0<br>0%'}</td>`;
                            html += `<td style="${cellRightStyle}">${proposedPct > 0 ? `$${Math.round(proposedFee).toLocaleString()}<br>${(proposedMER * 100).toFixed(2)}%` : '$0<br>0%'}</td>`;
                            html += `</tr>`;
                        });

                        // Net Investment Fees row (ALL bold including percentage - matches Word doc)
                        html += `<tr>`;
                        html += `<td style="${totalCellStyle}">Net Investment Fees and Costs<br>(per annum)</td>`;
                        html += `<td style="${totalCellRightStyle}">$${Math.round(existingTotalFee).toLocaleString()}<br>${(existingWeightedMER * 100).toFixed(2)}%</td>`;
                        html += `<td style="${totalCellRightStyle}">$${Math.round(proposedTotalFee).toLocaleString()}<br>${(proposedWeightedMER * 100).toFixed(2)}%</td>`;
                        html += `</tr>`;

                        // Difference row (spans all columns, not bold)
                        const feeDiff = proposedTotalFee - existingTotalFee;
                        html += `<tr><td colspan="3" style="${diffRowStyle}">Difference in ongoing costs (${feeDiff <= 0 ? 'Less' : 'Additional'} $${Math.abs(Math.round(feeDiff)).toLocaleString()})</td></tr>`;
                        html += `</table>`;
                        html += `<br/>`;
                    });

                    html += `</div>`;
                } else {
                    // Paraplanner Handoff format
                    const header = `<div style="font-family: Arial, sans-serif; max-width: 800px; color: #1e293b;">`;
                    const footer = `<p style="color: #94a3b8; font-size: 8pt; margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 12px;">Generated by Ford Scott Portfolio Builder | ${formatDate(new Date())}</p></div>`;

                    html = `${header}<div style="border-bottom: 3px solid #0d9488; padding-bottom: 12px; margin-bottom: 16px;"><h1 style="color: #0d9488; font-size: 18pt; margin: 0;">Portfolio Instruction</h1><p style="color: #64748b; margin: 0; font-size: 9pt;">Ford Scott Financial Planning</p></div><table cellpadding="6" style="width: 100%; margin-bottom: 16px; font-size: 10pt;"><tr><td style="color: #64748b; width: 100px;">Client:</td><td><strong>${clientName || 'â€”'}</strong></td><td style="color: #64748b; width: 100px;">Platform:</td><td><strong>${effectivePlatform}</strong></td></tr><tr><td style="color: #64748b;">Adviser:</td><td><strong>${adviserName || 'â€”'}</strong></td><td style="color: #64748b;">Date:</td><td><strong>${formatDate(dateCreated)}</strong></td></tr><tr><td style="color: #64748b;">Transaction:</td><td><strong>${transactionType}</strong></td><td style="color: #64748b;">Priority:</td><td style="font-weight: 600; color: ${priority === 'ASAP' ? '#dc2626' : priority === 'Urgent' ? '#d97706' : '#1e293b'}">${priority}</td></tr><tr><td style="color: #64748b;">Total Value:</td><td style="font-weight: 700; color: #0d9488;">${formatCurrency(combinedTotals.totalBalance)}</td><td style="color: #64748b;">Annual Fees:</td><td><strong>${formatCurrency(combinedTotals.totalFees)}</strong></td></tr></table>`;
                    accounts.forEach(a => {
                        const t = calculateAccountTotals(a.allocations, a.balance, customInvestments, merOverrides);
                        const accNum = a.accountNumber ? ` (${a.accountNumber})` : '';
                        html += `<div style="margin-top: 20px;"><div style="background: ${a.accountType === 'accumulation' ? '#0d9488' : '#115e59'}; color: white; padding: 10px 14px; border-radius: 6px 6px 0 0;"><strong>${a.accountType === 'accumulation' ? 'ACCUMULATION' : 'PENSION'}${accNum}</strong> â€” ${formatCurrency(a.balance)} | ${profileLabels[a.riskProfile]}${a.isESG ? ' | ESG' : ''} | Growth: ${t.totalGrowth.toFixed(0)}%</div><table border="1" cellpadding="8" style="width: 100%; border-collapse: collapse; font-size: 9pt;"><tr style="background: #f0fdfa;"><th style="text-align: left;">Investment</th><th style="text-align: right;">%</th><th style="text-align: right;">Amount</th><th style="text-align: right;">MER</th><th style="text-align: right;">Fee p.a.</th></tr>`;
                        Object.entries(a.allocations).filter(([_, p]) => p > 0).forEach(([n, p]) => {
                            const inv = allInvestments[n];
                            const mer = merOverrides[n] !== undefined ? merOverrides[n] : (inv?.mer || 0);
                            if (inv) html += `<tr><td>${n}</td><td style="text-align: right;">${p.toFixed(1)}%</td><td style="text-align: right;">${formatCurrency(a.balance * p / 100)}</td><td style="text-align: right;">${formatPercent(mer)}</td><td style="text-align: right;">${formatCurrency(a.balance * p / 100 * mer)}</td></tr>`;
                        });
                        html += `<tr style="background: #f1f5f9; font-weight: 600;"><td>Total</td><td style="text-align: right;">${t.totalAllocation.toFixed(1)}%</td><td style="text-align: right;">${formatCurrency(a.balance)}</td><td style="text-align: right;">${formatPercent(t.weightedMER)}</td><td style="text-align: right; color: #0d9488;">${formatCurrency(t.totalFees)}</td></tr></table></div>`;
                    });
                    if (notes) html += `<div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 16px;"><strong style="color: #92400e;">Notes:</strong><p style="color: #78350f; margin: 8px 0 0 0;">${notes}</p></div>`;
                    html += footer;
                }
                navigator.clipboard.write([new ClipboardItem({ 'text/html': new Blob([html], { type: 'text/html' }) })]).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
            };

            const hasAccumulation = accounts.some(a => a.accountType === 'accumulation');
            const hasPension = accounts.some(a => a.accountType === 'pension');

            
            const handleSharePortfolio = async (name, description) => {
                setSavingShare(true);
                try {
                    const portfolioData = {
                        clientName,
                        adviserName,
                        platform,
                        transactionType,
                        priority,
                        dateCreated,
                        accounts,
                        notes,
                        customInvestments,
                        merOverrides
                    };
                    await supabase.saveSharedPortfolio(name, description, portfolioData);
                    setShareMessage('Portfolio shared successfully!');
                    setShowShareModal(false);
                    setTimeout(() => setShareMessage(''), 3000);
                    // Reload shared portfolios
                    const updated = await supabase.fetchSharedPortfolios();
                    setSharedPortfolios(updated);
                } catch (error) {
                    setShareMessage('Error sharing portfolio: ' + error.message);
                    setTimeout(() => setShareMessage(''), 3000);
                } finally {
                    setSavingShare(false);
                }
            };

            const handleLoadSharedPortfolio = (portfolio) => {
                const data = portfolio.data_json;
                setClientName(data.clientName || '');
                setAdviserName(data.adviserName || '');
                setPlatform(data.platform || 'HUB24');
                setTransactionType(data.transactionType || 'New Investment');
                setPriority(data.priority || 'Standard');
                setDateCreated(data.dateCreated || new Date().toISOString().split('T')[0]);
                setAccounts(data.accounts || []);
                setNotes(data.notes || '');
                setCustomInvestments(data.customInvestments || {});
                setMerOverrides(data.merOverrides || {});
                setShowSharedPortfoliosModal(false);
                setShareMessage('Portfolio loaded successfully!');
                setTimeout(() => setShareMessage(''), 3000);
            };

return (
                <div className="min-h-screen">
                    <header className="bg-white border-b border-fs-slate-200 sticky top-0 z-50 no-print">
                        <div className="border-t-4 border-fs-teal-600"></div>
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div><h1 className="font-heading text-2xl font-bold text-fs-slate-800">Portfolio Builder</h1><p className="text-fs-slate-500 text-sm">Ford Scott Financial Planning</p></div>
                                <div className="flex items-center gap-3">
                                    <button onClick={handleSaveSnapshot} className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium hover:bg-indigo-200 flex items-center gap-2"><Icons.Camera /> Snapshot</button>
                                    <select value={selectedSavedPortfolio} onChange={(e) => handleLoadPortfolio(e.target.value)} className="border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white min-w-48"><option value="">Load portfolio...</option>{savedPortfoliosList.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                    {selectedSavedPortfolio && <button onClick={handleDeletePortfolio} className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm">Delete</button>}
                                    <button onClick={handleSavePortfolio} className="px-4 py-2 bg-fs-slate-100 text-fs-slate-700 rounded-lg text-sm font-medium hover:bg-fs-slate-200 flex items-center gap-2"><Icons.Save /> Save</button>
                                    <ExportDropdown onExport={handleExport} copied={copied} hasBaseline={!!baseline} />
                                    <button onClick={() => setShowShareModal(true)} className="px-4 py-2 bg-fs-teal-100 text-fs-teal-700 rounded-lg text-sm font-medium hover:bg-fs-teal-200 flex items-center gap-2"><Icons.Save /> Share to Team</button>
                                    <button onClick={() => setShowSharedPortfoliosModal(true)} className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium hover:bg-indigo-200 flex items-center gap-2"><Icons.Refresh /> Load Shared</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-6">
                        {baseline && <ComparisonSummary current={combinedTotals} baseline={baseline.totals} onClear={handleClearSnapshot} onViewDetails={() => setShowComparisonModal(true)} savedAt={baseline.savedAt} />}

                        <InvestmentComparisonModal isOpen={showComparisonModal} onClose={() => setShowComparisonModal(false)} baseline={baseline} accounts={accounts} customInvestments={customInvestments} merOverrides={merOverrides} />

                        <div className="bg-white rounded-xl shadow-sm border border-fs-slate-200 p-5 mb-6 no-print">
                            <h2 className="font-heading font-semibold text-fs-slate-800 mb-4">Client & Transaction Details</h2>
                            <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
                                <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Client Name</label><input type="text" value={clientName} onChange={(e) => setClientName(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="Client name..." /></div>
                                <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Adviser</label><input type="text" value={adviserName} onChange={(e) => setAdviserName(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="Adviser..." /></div>
                                <div>
                                    <label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Platform</label>
                                    {platform === 'Other' ? (
                                        <div className="flex gap-1"><input type="text" value={platformOther} onChange={(e) => setPlatformOther(e.target.value)} className="flex-1 border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" placeholder="Platform name..." /><button onClick={() => setPlatform('HUB24')} className="px-2 text-fs-slate-400 hover:text-fs-slate-600"><Icons.X /></button></div>
                                    ) : (
                                        <select value={platform} onChange={(e) => setPlatform(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white"><option value="HUB24">HUB24</option><option value="Other">Other...</option></select>
                                    )}
                                </div>
                                <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Transaction</label><select value={transactionType} onChange={(e) => setTransactionType(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm bg-white">{TRANSACTION_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Priority</label><select value={priority} onChange={(e) => setPriority(e.target.value)} className={`w-full border rounded-lg px-3 py-2 text-sm ${priority === 'ASAP' ? 'bg-red-50 border-red-300 text-red-700' : priority === 'Urgent' ? 'bg-amber-50 border-amber-300 text-amber-700' : 'border-fs-slate-300 bg-white'}`}>{PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                                <div><label className="block text-xs font-medium text-fs-slate-500 mb-1.5 uppercase">Date</label><input type="date" value={dateCreated} onChange={(e) => setDateCreated(e.target.value)} className="w-full border border-fs-slate-300 rounded-lg px-3 py-2 text-sm" /></div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-r from-fs-teal-700 to-fs-teal-800 rounded-xl shadow-lg p-6 mb-6 text-white">
                            <div className="flex flex-wrap justify-between items-center gap-6">
                                <div><p className="text-fs-teal-200 text-xs uppercase mb-1">Total Portfolio</p><p className="text-3xl font-heading font-bold tabular-nums">{formatCurrency(combinedTotals.totalBalance)}</p></div>
                                <div className="text-center"><p className="text-fs-teal-200 text-xs uppercase mb-1">Accounts</p><p className="text-2xl font-heading font-bold">{accounts.length}</p></div>
                                <div className="text-center"><p className="text-fs-teal-200 text-xs uppercase mb-1">Growth</p><p className="text-2xl font-heading font-bold tabular-nums">{combinedTotals.weightedGrowth.toFixed(1)}%{baseline && <DeltaIndicator current={combinedTotals.weightedGrowth} baseline={baseline.totals.weightedGrowth} />}</p></div>
                                <div className="text-center"><p className="text-fs-teal-200 text-xs uppercase mb-1">Defensive</p><p className="text-2xl font-heading font-bold tabular-nums">{combinedTotals.weightedDefensive.toFixed(1)}%</p></div>
                                <div><p className="text-fs-teal-200 text-xs uppercase mb-1">Annual Fees</p><p className="text-2xl font-heading font-bold tabular-nums">{formatCurrency(combinedTotals.totalFees)}{baseline && <DeltaIndicator current={combinedTotals.totalFees} baseline={baseline.totals.totalFees} format="currency" />}</p></div>
                                <div className="flex gap-2 no-print">
                                    {!hasAccumulation && <button onClick={() => addAccount('accumulation')} className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium flex items-center gap-2"><Icons.Plus /> Super</button>}
                                    {!hasPension && <button onClick={() => addAccount('pension')} className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium flex items-center gap-2"><Icons.Plus /> Pension</button>}
                                    {hasAccumulation && hasPension && <button onClick={() => addAccount('accumulation')} className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium flex items-center gap-2"><Icons.Plus /> Account</button>}
                                </div>
                            </div>
                        </div>

                        {accounts.map(a => <AccountPanel key={a.id} account={a} onUpdate={updateAccount} onRemove={() => removeAccount(a.id)} canRemove={accounts.length > 1} customInvestments={customInvestments} merOverrides={merOverrides} onMerChange={handleMerChange} merUnlocked={merUnlocked} onUnlockMer={handleMerUnlock} baselineTotals={baselineAccountTotals[a.id]} />)}

                        <div className="bg-white rounded-xl shadow-sm border border-fs-slate-200 p-5 mb-6 no-print">
                            <h2 className="font-heading font-semibold text-fs-slate-800 mb-3">Notes for Paraplanner</h2>
                            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Special instructions, context, or notes..." className="w-full h-28 border border-fs-slate-300 rounded-lg px-4 py-3 text-sm resize-none" />
                        </div>
                    
                        {shareMessage && (
                            <div className="fixed bottom-4 right-4 bg-emerald-50 border border-emerald-300 text-emerald-800 px-4 py-3 rounded-lg shadow-lg text-sm z-40">
                                {shareMessage}
                            </div>
                        )}

                        <ShareToTeamModal isOpen={showShareModal} onClose={() => setShowShareModal(false)} onSave={handleSharePortfolio} saving={savingShare} />
                        <SharedPortfoliosModal isOpen={showSharedPortfoliosModal} onClose={() => setShowSharedPortfoliosModal(false)} onLoad={handleLoadSharedPortfolio} portfolios={sharedPortfolios} loading={loadingSharedPortfolios} />
                    </main>

                    <footer className="border-t border-fs-slate-200 py-6 no-print"><div className="max-w-7xl mx-auto px-6 text-center"><p className="text-fs-slate-400 text-sm">Ford Scott Portfolio Builder v14.0.0 â€¢ February 2026</p></div></footer>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>